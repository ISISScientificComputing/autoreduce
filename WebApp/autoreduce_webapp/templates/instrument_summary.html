{% extends "base.html" %}
{% load view %}
{% load static from staticfiles %}
{% load colour_table_rows %}

{% block body %}
    {% if instrument %}
        {% if instrument.is_active %}
            <title>{{ instrument_name }}</title>
            <!-- Instrument Name -->
            <div class="row">
                <div class="col-md-12 text-center">
                    <h2>{{ instrument_name }}</h2>
                </div>
            </div>

            <!-- Instrument status and control buttons -->
            <div class="row">
                <div class="col-md-6">
                    {% include "snippets/instrument_status.html" with processing=processing queued=queued last_instrument_run=last_instrument_run only %}
                </div>
                <!-- Pause / Resume Reduction button-->
                <div class="col-md-6 text-center">
                    {% if instrument.is_paused %}
                        <a class="btn btn-danger btn-block" id="pause"><i class="fa fa-play"></i>&nbsp;&nbsp;Resume Autoreduction on {{instrument_name}}</a>
                    {% else %}
                        <a class="btn btn-success btn-block" id="pause"><i class="fa fa-pause"></i>&nbsp;&nbsp;Pause Autoreduction on {{instrument_name}}</a>
                    {% endif %}
                    <form id="form-pause" method="POST" action="{% url 'instrument_pause' instrument_name %}">
                        {% csrf_token %}
                        <input type="hidden" name="currently_paused" id="currently_paused" value="{{ instrument.is_paused }}">
                    </form>
                    <p></p>
                </div>
                <!-- Re-run past runs button -->
                <div class="col-md-6 text-center">
                    <p><a href="{% url 'instrument_submit_runs' instrument=instrument_name %}" class="btn btn-success btn-block"><i class="fa fa-arrow-left"></i>&nbsp;&nbsp;Re-run past jobs</a></p>
                </div>
                <!-- Configure new runs button -->
                <div class="col-md-6 text-center">
                    <p><a href="{% url 'instrument_variables' instrument=instrument_name %}" class="btn btn-success btn-block"><i class="fa fa-plus"></i>&nbsp;&nbsp;Configure New Jobs</a></p>
                </div>
            </div>

            <!-- Collapsible widget for reduction variables present and future -->
            {% if reduction_variables_on %}
            <div class="row">
                <div class="col-md-12 text-center">
                    <button type="button" class="btn btn-info btn-block" data-toggle="collapse" data-target="#variables"><i class="fa fa-chevron-down"></i>  Show Variables</button>
                    <div id="variables" class="collapse" style="background-color:#F0FFFF;">
                        {% view "reduction_variables.views.instrument_summary" instrument=instrument_name last_run_object=last_instrument_run %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center col-md-6 col-md-offset-3 well well-small">
                Instrument is not active.
            </div>
        {% endif %}

        <br/>
        <hr/>
        <br/>
            <!-- Display table for reduction jobs -->
            <div class="row">
                <!-- Filter and Pagination options -->
                <form action="{{ request.path }}" method="get" id="filter_options">
                    <div class="col-md-3">
                        <select class="form-control" name="filter" form="filter_options" id="filter_select">
                            <option value="{{ filtering }}" selected="selected">Filter by ...</option> <!-- Defaults to Run Number -->
                            <option value="run">Run number</option>
                            <option value="experiment">Experiment Reference (RB)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" name="pagination" form="filter_options" id="pagination_select">
                            <option value="{{ max_items }}" selected="selected">Items per page... </option>  <!-- Defaults to 50 items per page -->
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                            <option>100</option>
                            <option>250</option>
                            <option>500</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input class="btn btn-primary" type="submit" value="Apply filters">
                    </div>
                </form>
            </div>
            <br/>
            <!-- Display table for every reduction job -->
            <div class="row">
                <div class="tab-content col-md-12">
                    <!-- Run number filtered jobs -->
                    <div class="tab-pane row {% if default_tab == 'run_number' %}active{% else %}hide{% endif %}" id="by-run-number">
                        {% for run in paginator.current_page.records %}
                            {% if forloop.first %}
                                <div class="row run-row-top">
                            {% else %}
                                <div class="row run-row">
                            {% endif %}
                                <div class="col-md-5  col-sm-5 col-md-offset-1 col-xs-4"><a href="{% url 'run_summary' instrument_name=instrument_name run_number=run.run_number run_version=run.run_version %}">{{ run.title }}</a></div>
                                <div class="col-md-2 col-sm-2 col-xs-4 run-status text-{% colour_table_row run.status.value %}"><strong>{{ run.status }}</strong></div>
                                <div class="col-md-4 col-sm-5 col-xs-4"><strong>Last updated:</strong> {{ run.last_updated }}</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <br/>
            <!-- Paginator -->
            <div class="row">
                {% if paginator %}
                <div class="col-md-12 text-center">
                    <div class="btn-group" role="group">
                        {% if paginator.has_previous %}
                            <button title="First Page" class="btn btn-default" onclick="changePage(1)"><i class="fa fa-step-backward"></i></button>
                            <button title="Previous Page" class="btn btn-default" onclick="changePage({{ paginator.previous_page_index }})"><i class="fa fa-chevron-left"></i></button>
                        {% endif %}
                        {% for page in paginator.display_list %}
                            {% if page.is_visible %}
                                {% if page.number == paginator.current_page_index %}
                                    <button title="Current Page" class="btn btn-primary inline">{{ page.display_name }}</button>
                                {% else %}
                                    <button class="btn btn-default" onclick="changePage({{ page.number }})">{{ page.display_name }}</button>
                                {% endif %}
                            {% else %}
                                 <button title="There are additional pages. Please access them using the navigation buttons." class="btn btn-default disabled">...</button>
                            {% endif %}
                        {% endfor %}
                        {% if paginator.has_next %}
                            <button title="Next Page" class="btn btn-default" onclick="changePage({{ paginator.next_page_index }})"><i class="fa fa-chevron-right"></i></button>
                            <button title="Last page" class="btn btn-default" onclick="changePage({{ last_page_index }})"><i class="fa fa-step-forward"></i></button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="text-center col-md-6 col-md-offset-3 well well-small">
            Instrument not found.
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if preload_runs %}
        <script>window.preload_runs = true;</script>
    {% endif %}
    <script>
    function changePage(page) {
        var pagination_choice = document.getElementById("pagination_select").value;
        var filter_choice = document.getElementById("filter_select").value;
        var new_url = window.location.origin + window.location.pathname + '?page=' + arguments[0] + '&filter=' + filter_choice + '&pagination=' + pagination_choice;
        document.location.href = new_url;
    }
    </script>
    <script src="{% static "javascript/pause_instrument.js" %}"></script>
    <script src="{% static "javascript/instrument_variables.js" %}"></script>
{% endblock %}
