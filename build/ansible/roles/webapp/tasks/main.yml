---

- include_vars: vars/redhat.yml
  when: ansible_os_family == 'RedHat'

- name: 'Install Apache 2 and the wsgi module'
  package:
    name: '{{ item }}'
    state: present
  with_items: '{{ webapp_pkgs }}'

- name: 'Add server name to httpd.conf'
  lineinfile:
    path: '{{ apache_config }}'
    line: 'ServerName {{inventory_hostname}}'

- name: 'Add wsgi config to httpd.conf'
  lineinfile:
    path: '{{ apache_config }}'
    line: 'Include /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/apache/apache_django_wsgi.conf'

- name: 'Copy the wsgi configuration template'
  shell: 'cp /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/apache/apache_django_wsgi.conf.template /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/apache/apache_django_wsgi.conf'

- name: 'Fill the template file'
  replace:
    path: /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/apache/apache_django_wsgi.conf
    regexp: '\{0\}'
    replace: '/home/autoreduction/autoreduction'

- name: 'Set the correct permissions on autoreduction.log'
  copy:
    content: ""
    dest: /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/autoreduction.log
    owner: '{{ apache_user }}'
    group: '{{ apache_user }}'

- name: 'Add host name to the list of allowed hosts'
  replace:
    path: /home/autoreduction/autoreduction/WebApp/autoreduce_webapp/autoreduce_webapp/settings.py
    regexp: 'ALLOWED_HOSTS.*$'
    replace: "ALLOWED_HOSTS = ['{{inventory_hostname}}', '127.0.0.1', 'localhost']"

- name: 'Restart Apache2'
  service:
    name: '{{ apache_service }}'
    state: restarted
